In/IN Bjarne/NNP Stroustrup/NNP 's/POS The/DT C++/COS Programming/NN Language/NN 4th/CD edition/NN section/NN 36.3.6/CD STL-like/JJ Operations/NN the/DT following/JJ code/NN is/VBZ used/VBN as/IN an/DT example/NN of/IN chaining/VBG :/: void/COB f2/COB -LRB-/COB -RRB-/COB -LCB-/COB std/COB :/COB :/COB string/COB s/COB =/COB ``/COB but/CC I/PRP have/VBP heard/VBN it/PRP works/VBZ even/RB if/IN you/PRP do/VBP n't/RB believe/VB in/IN it/PRP ''/COB ;/COB s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB ''/COB ''/COB -RRB-/COB ./COB
replace/COB -LRB-/COB s.find/COB -LRB-/COB ``/COB even/COB ''/COB -RRB-/COB ,/COB 4/COB ,/COB ``/COB only/COB ''/COB -RRB-/COB ./COB
replace/COB -LRB-/COB s.find/COB -LRB-/COB ''/COB do/COB n't/COB ''/COB -RRB-/COB ,/COB 6/COB ,/COB ''/COB ''/COB -RRB-/COB ;/COB assert/COB -LRB-/COB s/COB ==/COB ``/COB I/PRP have/VBP heard/VBN it/PRP works/VBZ only/RB if/IN you/PRP believe/VBP in/IN it/PRP ''/'' -RRB-/-RRB- ;/: -RCB-/-RRB- The/DT assert/VBP fails/VBZ in/IN gcc/ACR -LRB-/-LRB- see/VB it/PRP live/VB -RRB-/-RRB- and/CC Visual/NNP Studio/NNP -LRB-/-LRB- see/VB it/PRP live/VB -RRB-/-RRB- ,/, but/CC it/PRP does/VBZ not/RB fail/VB when/WRB using/VBG Clang/NNP -LRB-/-LRB- see/VB it/PRP live/VB -RRB-/-RRB- ./.
Why/WRB am/VBP I/PRP getting/VBG different/JJ results/NNS ?/.
Are/VBP any/DT of/IN these/DT compilers/NNS incorrectly/RB evaluating/VBG the/DT chaining/VBG expression/NN or/CC does/VBZ this/DT code/NN exhibit/VBP some/DT form/NN of/IN unspecified/JJ or/CC undefined/JJ behavior/NN ?/.
The/DT code/NN exhibits/VBZ unspecified/JJ behavior/NN due/JJ to/TO unspecified/JJ order/NN of/IN evaluation/NN of/IN sub-expressions/NNS although/IN it/PRP does/VBZ not/RB invoke/VB undefined/JJ behavior/NN since/IN all/DT side/JJ effects/NNS are/VBP done/VBN within/IN functions/NNS which/WDT introduces/VBZ a/DT sequencing/NN relationship/NN between/IN the/DT side/JJ effects/NNS in/IN this/DT case/NN ./.
This/DT example/NN is/VBZ mentioned/VBN in/IN the/DT proposal/NN N4228/COS :/: Refining/VBG Expression/NN Evaluation/NN Order/NN for/IN Idiomatic/NN C++/COS which/WDT says/VBZ the/DT following/NN about/IN the/DT code/NN in/IN the/DT question/NN :/: -LSB-/-LRB- .../: -RSB-/-RRB- This/DT code/NN has/VBZ been/VBN reviewed/VBN by/IN C++/COS experts/NNS world-wide/JJ ,/, and/CC published/VBN -LRB-/-LRB- The/DT C++/COS Programming/NN Language/NN ,/, 4th/CD edition/NN ./. -RRB-/-RRB-
Yet/RB ,/, its/PRP$ vulnerability/NN to/TO unspecified/JJ order/NN of/IN evaluation/NN has/VBZ been/VBN discovered/VBN only/RB recently/RB by/IN a/DT tool/NN -LSB-/-LRB- .../: -RSB-/-RRB- Details/NNS It/PRP may/MD be/VB obvious/JJ to/TO many/JJ that/IN arguments/NNS to/TO functions/NNS have/VBP an/DT unspecified/JJ order/NN of/IN evaluation/NN but/CC it/PRP is/VBZ probably/RB not/RB as/IN obvious/JJ how/WRB this/DT behavior/NN interacts/VBZ with/IN chained/JJ functions/NNS calls/NNS ./.
It/PRP was/VBD not/RB obvious/JJ to/TO me/PRP when/WRB I/PRP first/RB analyzed/VBD this/DT case/NN and/CC apparently/RB not/RB to/TO all/PDT the/DT expert/JJ reviewers/NNS either/RB ./.
At/IN first/JJ glance/NN it/PRP may/MD appear/VB that/IN since/IN each/DT replace/VBP has/VBZ to/TO be/VB evaluated/VBN from/IN left/NN to/TO right/NN that/IN the/DT corresponding/JJ function/NN argument/NN groups/NNS must/MD be/VB evaluated/VBN as/IN groups/NNS from/IN left/VBN to/TO right/RB as/RB well/RB ./.
This/DT is/VBZ incorrect/JJ ,/, function/NN arguments/NNS have/VBP an/DT unspecified/JJ order/NN of/IN evaluation/NN ,/, although/IN chaining/VBG function/NN calls/NNS does/VBZ introduce/VB a/DT left/NN to/TO right/JJ evaluation/NN order/NN for/IN each/DT function/NN call/NN ,/, the/DT arguments/NNS of/IN each/DT function/NN call/NN are/VBP only/RB sequenced/VBN before/RB with/IN respect/NN to/TO the/DT member/NN function/NN call/VBP they/PRP are/VBP part/NN of/IN ./.
In/IN particular/JJ this/DT impacts/VBZ the/DT following/JJ calls/NNS :/: s.find/COB -LRB-/COB ``/COB even/COB ''/COB -RRB-/COB and/COB :/COB s.find/COB -LRB-/COB ''/COB do/COB n't/COB ''/COB -RRB-/COB which/WDT are/VBP indeterminately/RB sequenced/VBN with/IN respect/NN to/TO :/: s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB ''/COB ''/COB -RRB-/COB the/DT two/CD find/VBP calls/NNS could/MD be/VB evaluated/VBN before/IN or/CC after/IN the/DT replace/VB ,/, which/WDT matters/VBZ since/IN it/PRP has/VBZ a/DT side/JJ effect/NN on/IN s/NN in/IN a/DT way/NN that/WDT would/MD alter/VB the/DT result/NN of/IN find/VB ,/, it/PRP changes/VBZ the/DT length/NN of/IN s/NN ./.
So/RB depending/VBG on/IN when/WRB that/WDT replace/VBP is/VBZ evaluated/VBN relative/JJ to/TO the/DT two/CD find/VBP calls/NNS the/DT result/NN will/MD differ/VB ./.
If/IN we/PRP look/VBP at/IN the/DT chaining/VBG expression/NN and/CC examine/VB the/DT evaluation/NN order/NN of/IN some/DT of/IN the/DT sub-expressions/NNS :/: s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB ''/COB ''/COB -RRB-/COB ./COB
replace/COB -LRB-/COB s.find/COB -LRB-/COB ``/COB even/COB ''/COB -RRB-/COB ,/COB 4/COB ,/COB ``/COB only/COB ''/COB -RRB-/COB ^/COB ^/COB ^/COB ^/COB ^/COB ^/COB ^/COB ^/COB ^/COB A/COB B/COB |/COB |/COB |/COB C/COB |/COB |/COB |/COB 1/COB 2/COB 3/COB 4/COB 5/COB 6/COB and/COB :/COB ./COB
replace/COB -LRB-/COB s.find/COB -LRB-/COB ''/COB do/COB n't/COB ''/COB -RRB-/COB ,/COB 6/COB ,/COB ''/COB ''/COB -RRB-/COB ;/COB ^/COB ^/COB ^/COB ^/COB D/COB |/COB |/COB |/COB 7/COB 8/COB 9/COB Note/VBP ,/, we/PRP are/VBP ignoring/VBG the/DT fact/NN that/IN 4/CD and/CC 7/CD can/MD be/VB further/RB broken/VBN down/RP into/IN more/JJR sub-expressions/NNS ./.
So/RB :/: A/NN is/VBZ sequenced/VBN before/IN B/NN which/WDT is/VBZ sequenced/VBN before/IN C/NN which/WDT is/VBZ sequenced/VBN before/IN D/NN 1/CD to/TO 9/CD are/VBP indeterminately/RB sequenced/VBN with/IN respect/NN to/TO other/JJ sub-expressions/NNS with/IN some/DT of/IN the/DT exceptions/NNS listed/VBN below/IN 1/CD to/TO 3/CD are/VBP sequenced/VBN before/IN B/NN 4/CD to/TO 6/CD are/VBP sequenced/VBN before/IN C/NN 7/CD to/TO 9/CD are/VBP sequenced/VBN before/IN D/NN The/DT key/NN to/TO this/DT issue/NN is/VBZ that/IN :/: 4/CD to/TO 9/CD are/VBP indeterminately/RB sequenced/VBN with/IN respect/NN to/TO B/NN The/DT potential/JJ order/NN of/IN evaluation/NN choice/NN for/IN 4/CD and/CC 7/CD with/IN respect/NN to/TO B/NN explains/VBZ the/DT difference/NN in/IN results/NNS between/IN clang/NN and/CC gcc/ACR when/WRB evaluating/VBG f2/COS -LRB-/COS -RRB-/COS ./.
In/IN my/PRP$ tests/NNS clang/NN evaluates/VBZ B/NN before/IN evaluating/VBG 4/CD and/CC 7/CD while/IN gcc/ACR evaluates/VBZ it/PRP after/IN ./.
We/PRP can/MD use/VB the/DT following/JJ test/NN program/NN to/TO demonstrate/VB what/WP is/VBZ happening/VBG in/IN each/DT case/NN :/: #include/COB <iostream>/COB #include/COB <string>/COB std/COB :/COB :/COB string/COB :/COB COB/COB size_type/COB my_find/COB -LRB-/COB std/COB :/COB :/COB string/COB s/COB ,/COB const/COB char/COB */COB cs/COB -RRB-/COB -LCB-/COB std/COB :/COB :/COB string/COB :/COB :/COB size_type/COB pos/COB =/COB s.find/COB -LRB-/COB cs/COB -RRB-/COB ;/COB std/COB :/COB :/COB cout/COB <</COB ``/COB position/COB ''/COB <</COB cs/COB <</COB ''/COB found/VBN in/IN complete/JJ expression/NN :/: ''/COB <</COB pos/COB <</COB std/COB :/COB :/COB endl/COB ;/COB return/COB pos/COB ;/COB -RCB-/COB int/COB main/COB -LRB-/COB -RRB-/COB -LCB-/COB std/COB :/COB :/COB string/COB s/COB =/COB ``/COB but/CC I/PRP have/VBP heard/VBN it/PRP works/VBZ even/RB if/IN you/PRP do/VBP n't/RB believe/VB in/IN it/PRP ''/COB ;/COB std/COB :/COB :/COB string/COB copy_s/COB =/COB s/COB ;/COB std/COB :/COB :/COB cout/COB <</COB ``/COB position/NN of/IN even/RB before/IN s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB \/COB ''/COB \/COB ''/COB -RRB-/COB :/COB ''/COB <</COB s.find/COB -LRB-/COB ``/COB even/COB ''/COB -RRB-/COB <</COB std/COB :/COB :/COB endl/COB ;/COB std/COB :/COB :/COB cout/COB <</COB ``/COB position/NN of/IN do/VBP n't/RB before/IN s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB \/COB ''/COB \/COB ''/COB -RRB-/COB :/COB ''/COB <</COB s.find/COB -LRB-/COB ''/COB do/COB n't/COB ''/COB -RRB-/COB <</COB std/COB :/COB :/COB endl/COB <</COB std/COB :/COB :/COB endl/COB ;/COB copy_s/COB ./COB
replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB ''/COB ''/COB -RRB-/COB ;/COB std/COB :/COB :/COB cout/COB <</COB ``/COB position/COB of/COB even/COB after/COB s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB \/COB ''/COB \/COB ''/COB -RRB-/COB :/COB ''/COB <</COB copy_s/COB ./COB
find/COB -LRB-/COB ``/COB even/COB ''/COB -RRB-/COB <</COB std/COB :/COB :/COB endl/COB ;/COB std/COB :/COB :/COB cout/COB <</COB ``/COB position/NN of/IN do/VBP n't/RB after/IN s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB \/COB ''/COB \/COB ''/COB -RRB-/COB :/COB ''/COB <</COB copy_s/COB ./COB
find/COB -LRB-/COB ''/COB do/COB n't/COB ''/COB -RRB-/COB <</COB std/COB :/COB :/COB endl/COB <</COB std/COB :/COB :/COB endl/COB ;/COB s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB ''/COB ''/COB -RRB-/COB ./COB
replace/COB -LRB-/COB my_find/COB -LRB-/COB s/COB ,/COB ``/COB even/COB ''/COB -RRB-/COB ,/COB 4/COB ,/COB ``/COB only/COB ''/COB -RRB-/COB ./COB
replace/COB -LRB-/COB my_find/COB -LRB-/COB s/COB ,/COB ''/COB do/COB n't/COB ''/COB -RRB-/COB ,/COB 6/COB ,/COB ''/COB ''/COB -RRB-/COB ;/COB std/COB :/COB :/COB cout/COB <</COB ``/COB Result/NN :/: ''/COB <</COB s/COB <</COB std/COB :/COB :/COB endl/COB ;/COB -RCB-/COB Result/NN for/IN gcc/ACR -LRB-/-LRB- see/VB it/PRP live/JJ -RRB-/-RRB- position/NN of/IN even/RB before/IN s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB ''/COB ''/COB -RRB-/COB :/: 26/CD position/NN of/IN do/VBP n't/RB before/IN s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB ''/COB ''/COB -RRB-/COB :/: 37/CD position/NN of/IN even/RB after/IN s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB ''/COB ''/COB -RRB-/COB :/: 22/CD position/NN of/IN do/VBP n't/RB after/IN s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB ''/COB ''/COB -RRB-/COB :/: 33/CD position/NN do/VBP n't/RB found/VBN in/IN complete/JJ expression/NN :/: 37/CD position/NN even/RB found/VBN in/IN complete/JJ expression/NN :/: 26/CD Result/NN :/: I/PRP have/VBP heard/VBN it/PRP works/VBZ evenonlyyou/FW donieve/FW in/IN it/PRP Result/NN for/IN clang/NNP -LRB-/-LRB- see/VB it/PRP live/JJ -RRB-/-RRB- :/: position/NN of/IN even/RB before/IN s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB ''/COB ''/COB -RRB-/COB :/: 26/CD position/NN of/IN do/VBP n't/RB before/IN s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB ''/COB ''/COB -RRB-/COB :/: 37/CD position/NN of/IN even/RB after/IN s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB ''/COB ''/COB -RRB-/COB :/: 22/CD position/NN of/IN do/VBP n't/RB after/IN s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB ''/COB ''/COB -RRB-/COB :/: 33/CD position/NN even/RB found/VBN in/IN complete/JJ expression/NN :/: 22/CD position/NN do/VBP n't/RB found/VBN in/IN complete/JJ expression/NN :/: 33/CD Result/NN :/: I/PRP have/VBP heard/VBN it/PRP works/VBZ only/RB if/IN you/PRP believe/VBP in/IN it/PRP Result/NN for/IN Visual/NNP Studio/NNP -LRB-/-LRB- see/VB it/PRP live/JJ -RRB-/-RRB- :/: position/NN of/IN even/RB before/IN s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB ''/COB ''/COB -RRB-/COB :/: 26/CD position/NN of/IN do/VBP n't/RB before/IN s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB ''/COB ''/COB -RRB-/COB :/: 37/CD position/NN of/IN even/RB after/IN s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB ''/COB ''/COB -RRB-/COB :/: 22/CD position/NN of/IN do/VBP n't/RB after/IN s.replace/COB -LRB-/COB 0/COB ,/COB 4/COB ,/COB ''/COB ''/COB -RRB-/COB :/: 33/CD position/NN do/VBP n't/RB found/VBN in/IN complete/JJ expression/NN :/: 37/CD position/NN even/RB found/VBN in/IN complete/JJ expression/NN :/: 26/CD Result/NN :/: I/PRP have/VBP heard/VBN it/PRP works/VBZ evenonlyyou/FW donieve/FW in/IN it/PRP Details/NNS from/IN the/DT standard/NN We/PRP know/VBP that/IN unless/IN specified/VBN the/DT evaluations/NNS of/IN sub-expressions/NNS are/VBP unsequenced/JJ ,/, this/DT is/VBZ from/IN the/DT draft/NN C++/COS 11/CD standard/JJ section/NN 1.9/CD Program/NN execution/NN which/WDT says/VBZ :/: Except/IN where/WRB noted/VBN ,/, evaluations/NNS of/IN operands/NNS of/IN individual/JJ operators/NNS and/CC of/IN subexpressions/NNS of/IN individual/JJ expressions/NNS are/VBP unsequenced/JJ ./.
-LSB-/-LRB- .../: -RSB-/-RRB- and/CC we/PRP know/VBP that/IN a/DT function/NN call/NN introduces/VBZ a/DT sequenced/VBN before/IN relationship/NN of/IN the/DT function/NN calls/VBZ postfix/NN expression/NN and/CC arguments/NNS with/IN respect/NN to/TO the/DT function/NN body/NN ,/, from/IN section/NN 1.9/CD :/: -LSB-/-LRB- .../: -RSB-/-RRB- When/WRB calling/VBG a/DT function/NN -LRB-/-LRB- whether/IN or/CC not/RB the/DT function/NN is/VBZ inline/NN -RRB-/-RRB- ,/, every/DT value/NN computation/NN and/CC side/NN effect/NN associated/VBN with/IN any/DT argument/NN expression/NN ,/, or/CC with/IN the/DT postfix/NN expression/NN designating/VBG the/DT called/VBN function/NN ,/, is/VBZ sequenced/VBN before/IN execution/NN of/IN every/DT expression/NN or/CC statement/NN in/IN the/DT body/NN of/IN the/DT called/VBN function/NN ./.
-LSB-/-LRB- .../: -RSB-/-RRB- We/PRP also/RB know/VBP that/IN class/NN member/NN access/NN and/CC therefore/RB chaining/VBG will/MD evaluate/VB from/IN left/NN to/TO right/NN ,/, from/IN section/NN 5.2.5/CD Class/NN member/NN access/NN which/WDT says/VBZ :/: -LSB-/-LRB- .../: -RSB-/-RRB- The/DT postfix/NN expression/NN before/IN the/DT dot/NN or/CC arrow/NN is/VBZ evaluated/VBN ;/: 64/CD the/DT result/NN of/IN that/DT evaluation/NN ,/, together/RB with/IN the/DT id-expression/NN ,/, determines/VBZ the/DT result/NN of/IN the/DT entire/JJ postfix/NN expression/NN ./.
Note/VB ,/, in/IN the/DT case/NN where/WRB the/DT id-expression/NN ends/VBZ up/RP being/VBG a/DT non-static/JJ member/NN function/NN it/PRP does/VBZ not/RB specify/VB the/DT order/NN of/IN evaluation/NN of/IN the/DT expression-list/NN within/IN the/DT -LRB-/-LRB- -RRB-/-RRB- since/IN that/DT is/VBZ a/DT separate/JJ sub-expression/NN ./.
The/DT relevant/JJ grammar/NN from/IN 5.2/CD Postfix/COB expressions/COB :/COB postfix-expression/COB :/COB postfix-expression/COB -LRB-/COB expression-listopt/COB -RRB-/COB //COB //COB function/COB call/COB postfix-expression/COB ./COB
templateopt/COB id-expression/COB //COB //COB Class/NN member/NN access/NN ,/, ends/VBZ //: //: up/RB as/IN a/DT postfix-expression/JJ @MattMcNabb/ATS it/PRP is/VBZ pity/NN I/PRP did/VBD not/RB find/VB this/DT code/NN organically/RB it/PRP is/VBZ bit/RB different/JJ when/WRB you/PRP know/VBP there/EX is/VBZ a/DT problem/NN with/IN code/NN versus/CC seeing/VBG code/NN you/PRP have/VBP no/DT preconceived/JJ notions/NNS about/IN ./.
I/PRP have/VBP to/TO say/VB ,/, it/PRP was/VBD not/RB obvious/JJ where/WRB the/DT specific/JJ issue/NN was/VBD even/RB though/IN I/PRP knew/VBD what/WP I/PRP was/VBD looking/VBG for/IN ,/, so/IN I/PRP can/MD see/VB how/WRB it/PRP could/MD have/VB been/VBN missed/VBN ./.
