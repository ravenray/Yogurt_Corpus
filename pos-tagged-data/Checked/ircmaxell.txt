Yes/UH ,/, except/IN that/DT PDO/ACR does/VBZ n't/RB use/VB real/JJ prepared/JJ statements/NNS by/IN default/NN ;--RRB-/EMO ./.
See/VB my/PRP$ answer/NN below/IN for/IN a/DT demonstration/NN and/CC explanation/NN of/IN an/DT attack/NN .../: The/DT short/JJ answer/NN is/VBZ NO/UH ,/, PDO/ACR prepares/VBZ will/MD not/RB defend/VB you/PRP from/IN all/DT possible/JJ SQL-Injection/COS attacks/NNS ./.
For/IN certain/JJ obscure/JJ edge-cases/NNS ./.
I/PRP 'm/VBP adapting/VBG this/DT answer/NN to/TO talk/VB about/IN PDO/ACR .../: The/DT long/JJ answer/NN is/VBZ n't/RB so/RB easy/JJ ./.
It/PRP 's/VBZ based/VBN off/RP an/DT attack/NN demonstrated/VBD here/RB ./.
The/DT Attack/NN So/RB ,/, let/VB 's/POS start/VB off/RP by/IN showing/VBG the/DT attack/NN .../: $/COB pdo/COB -/COB >/COB query/COB -LRB-/COB `/COB SET/COB NAMES/COB gbk/COB '/COB -RRB-/COB ;/COB $/COB var/COB =/COB ''/COB \/COB xbf/COB \/COB x27/COB OR/COB 1/COB =/COB 1/COB //COB */COB ''/COB ;/COB $/COB query/COB =/COB `/COB SELECT/COB */COB FROM/COB test/COB WHERE/COB name/COB =/COB ?/COB
LIMIT/COB 1/COB '/COB ;/COB $/COB stmt/COB =/COB $/COB pdo/COB -/COB >/COB prepare/COB -LRB-/COB $/COB query/COB -RRB-/COB ;/COB $/COB stmt/COB -/COB >/COB execute/COB -LRB-/COB array/COB -LRB-/COB $/COB var/COB -RRB-/COB -RRB-/COB ;/COB In/IN certain/JJ circumstances/NNS ,/, that/WDT will/MD return/VB more/JJR than/IN 1/CD row/NN ./.
Let/VB 's/POS dissect/VB what/WP 's/VBZ going/VBG on/IN here/RB :/: Selecting/VBG a/DT Character/NN Set/VB $/COB pdo/COB -/COB >/COB query/COB -LRB-/COB `/COB SET/COB NAMES/COB gbk/COB '/COB -RRB-/COB ;/COB For/IN this/DT attack/NN to/TO work/VB ,/, we/PRP need/VBP the/DT encoding/NN that/IN the/DT server/NN 's/POS expecting/VBG on/IN the/DT connection/NN both/DT to/TO encode/VB '/'' as/IN in/IN ASCII/ACR i.e./FW 0x27/COS and/CC to/TO have/VB some/DT character/NN whose/WP$ final/JJ byte/NN is/VBZ an/DT ASCII/ACR \/CD i.e./FW 0x5c/COS ./.
As/IN it/PRP turns/VBZ out/RP ,/, there/EX are/VBP 5/CD such/JJ encodings/NNS supported/VBN in/IN MySQL/COS 5.6/CD by/IN default/NN :/: big5/COS ,/, cp932/COS ,/, gb2312/COS ,/, bgk/COS and/CC sjis/COS ./.
We/PRP 'll/MD select/VB gbk/COS here/RB ./.
Now/RB ,/, it/PRP 's/VBZ very/RB important/JJ to/TO note/VB the/DT use/NN of/IN SET/COS NAMES/COS here/RB ./.
This/DT sets/VBZ the/DT character/NN set/VBN ON/IN THE/DT SERVER/NN ./.
There/EX is/VBZ another/DT way/NN of/IN doing/VBG it/PRP ,/, but/CC we/PRP 'll/MD get/VB there/EX soon/RB enough/RB ./.
The/DT Payload/NN The/DT payload/NN we/PRP 're/VBP going/VBG to/TO use/VB for/IN this/DT injection/NN starts/VBZ with/IN the/DT byte/NN sequence/NN 0xbf27/COS ./.
In/IN gbk/COS ,/, that/DT 's/VBZ an/DT invalid/JJ multibyte/JJ character/NN ;/: in/IN latin1/COS ,/, it/PRP 's/VBZ the/DT string/NN Â¿/SYM '/'' ./.
Note/VB that/IN in/IN latin1/COS and/CC gbk/COS ,/, 0x27/COS on/IN its/PRP$ own/JJ is/VBZ a/DT literal/JJ '/POS character/NN ./.
We/PRP have/VBP chosen/VBN this/DT payload/NN because/IN ,/, if/IN we/PRP called/VBD addslashes/COS -LRB-/COS -RRB-/COS on/IN it/PRP ,/, we/PRP 'd/MD insert/VB an/DT ASCII/ACR \/CD i.e./FW 0x5c/COS ,/, before/IN the/DT '/'' character/NN ./.
So/RB we/PRP 'd/MD wind/VB up/RP with/IN 0xbf5c27/COS ,/, which/WDT in/IN gbk/COS is/VBZ a/DT two/CD character/NN sequence/NN :/: 0xbf5c/COS followed/VBN by/IN 0x27/COS ./.
Or/CC in/IN other/PRP words/NNS ,/, a/DT valid/JJ character/NN followed/VBN by/IN an/DT unescaped/JJ '/'' ./.
But/CC we/PRP 're/VBP not/RB using/VBG addslashes/COS -LRB-/COS -RRB-/COS ./.
So/RB on/IN to/TO the/DT next/JJ step/NN .../: $/COB stmt/COB -/COB >/COB execute/COB -LRB-/COB -RRB-/COB The/DT important/JJ thing/NN to/TO realize/VB here/RB is/VBZ that/IN PDO/ACR by/IN default/NN does/VBZ NOT/RB do/VB true/JJ prepared/JJ statements/NNS ./.
It/PRP emulates/VBZ them/PRP -LRB-/-LRB- for/IN MySQL/COS -RRB-/-RRB- ./.
Therefore/RB ,/, PDO/ACR internally/RB builds/VBZ the/DT query/NN string/NN ,/, calling/VBG mysql_real_escape_string/COS -LRB-/COS -RRB-/COS -LRB-/-LRB- the/DT MySQL/COS C/NNP API/ACR function/NN -RRB-/-RRB- on/IN each/DT bound/VBN string/NN value/NN ./.
The/DT C/NNP API/COS call/NN to/TO mysql_real_escape_string/COS -LRB-/COS -RRB-/COS differs/VBZ from/IN addslashes/COS -LRB-/COS -RRB-/COS in/IN that/IN it/PRP knows/VBZ the/DT connection/NN character/NN set/NN ./.
So/RB it/PRP can/MD perform/VB the/DT escaping/VBG properly/RB for/IN the/DT character/NN set/VBN that/IN the/DT server/NN is/VBZ expecting/VBG ./.
However/RB ,/, up/IN to/TO this/DT point/NN ,/, the/DT client/NN thinks/VBZ that/IN we/PRP 're/VBP still/RB using/VBG latin1/COS for/IN the/DT connection/NN ,/, because/IN we/PRP never/RB told/VBD it/PRP otherwise/RB ./.
We/PRP did/VBD tell/VB the/DT server/NN we/PRP 're/VBP using/VBG gbk/COS ,/, but/CC the/DT client/NN still/RB thinks/VBZ it/PRP 's/POS latin1/COS ./.
Therefore/RB the/DT call/NN to/TO mysql_real_escape_string/COS -LRB-/COS -RRB-/COS inserts/NNS the/DT backslash/NN ,/, and/CC we/PRP have/VBP a/DT free/JJ hanging/NN '/'' character/NN in/IN our/PRP$ ``/`` escaped/VBN ''/'' content/NN !/.
In/IN fact/NN ,/, if/IN we/PRP were/VBD to/TO look/VB at/IN $/COB var/COB in/COB the/COB gbk/COB character/COB set/COB ,/, we/PRP 'd/MD see/VB :/: ?/COB '/COB
OR/COB 1/COB =/COB 1/COB //COB */COB Which/WDT is/VBZ exactly/RB what/WP the/DT attack/NN requires/VBZ ./.
The/DT Query/NN This/DT part/NN is/VBZ just/RB a/DT formality/NN ,/, but/CC here/RB 's/VBZ the/DT rendered/VBN query/NN :/: SELECT/COB */COB FROM/COB test/COB WHERE/COB name/COB =/COB '/COB ?/COB '/COB
OR/COB 1/COB =/COB 1/COB //COB */COB '/COB LIMIT/COB 1/COB Congratulations/NNS ,/, you/PRP just/RB successfully/RB attacked/VBN a/DT program/NN using/VBG PDO/ACR Prepared/JJ Statements/NN .../: The/DT Simple/JJ Fix/VB Now/RB ,/, it/PRP 's/VBZ worth/JJ noting/VBG that/IN you/PRP can/MD prevent/VB this/DT by/IN disabling/VBG emulated/VBN prepared/JJ statements/NNS :/: $/COB pdo/COB -/COB >/COB setAttribute/COB -LRB-/COB PDO/COB :/COB :/COB ATTR_EMULATE_PREPARES/COB ,/COB false/COB -RRB-/COB ;/COB This/DT will/MD usually/RB result/VB in/IN a/DT true/JJ prepared/JJ statement/NN -LRB-/-LRB- i.e./FW the/DT data/NNS being/VBG sent/VBN over/RP in/IN a/DT separate/JJ packet/NN from/IN the/DT query/NN -RRB-/-RRB- ./.
However/RB ,/, be/VB aware/JJ that/IN PDO/ACR will/MD silently/RB fallback/JJ to/TO emulating/VBG statements/NNS that/IN MySQL/COS ca/MD n't/RB prepare/VB natively/RB :/: those/DT that/IN it/PRP can/MD are/VB listed/VBN in/IN the/DT manual/NN ,/, but/CC beware/VBP to/TO select/VB the/DT appropriate/JJ server/NN version/NN -RRB-/-RRB- ./.
The/DT Correct/NN Fix/VB The/DT problem/NN here/RB is/VBZ that/IN we/PRP did/VBD n't/RB call/VB the/DT C/NNP API/ACR 's/POS mysql_set_charset/COS -LRB-/COS -RRB-/COS instead/RB of/IN SET/COS NAMES/COS ./.
If/IN we/PRP did/VBD ,/, we/PRP 'd/MD be/VB fine/RB provided/VBN we/PRP are/VBP using/VBG a/DT MySQL/COS release/NN since/IN 2006/CD ./.
If/IN you/PRP 're/VBP using/VBG an/DT earlier/JJR MySQL/COS release/NN ,/, then/RB a/DT bug/NN in/IN mysql_real_escape_string/COS -LRB-/COS -RRB-/COS meant/VBN that/IN invalid/JJ multibyte/JJ characters/NNS such/JJ as/IN those/DT in/IN our/PRP$ payload/NN were/VBD treated/VBN as/IN single/JJ bytes/NNS for/IN escaping/VBG purposes/NNS even/RB if/IN the/DT client/NN had/VBD been/VBN correctly/RB informed/VBN of/IN the/DT connection/NN encoding/VBG and/CC so/RB this/DT attack/NN would/MD still/RB succeed/VB ./.
The/DT bug/NN was/VBD fixed/VBN in/IN MySQL/COS 4.1.20/CD ,/, 5.0.22/CD and/CC 5.1.11/CD ./.
But/CC the/DT worst/JJS part/NN is/VBZ that/IN PDO/ACR did/VBD n't/RB expose/VB the/DT C/NNP API/ACR for/IN mysql_set_charset/COS -LRB-/COS -RRB-/COS until/IN 5.3.6/CD ,/, so/RB in/IN prior/JJ versions/NNS it/PRP can/MD not/RB prevent/VB this/DT attack/NN for/IN every/DT possible/JJ command/NN !/.
It/PRP 's/VBZ now/RB exposed/VBN as/IN a/DT DSN/ACR parameter/NN ,/, which/WDT should/MD be/VB used/VBN instead/RB of/IN SET/COS NAMES/COS .../: The/DT Saving/VBG Grace/NN As/IN we/PRP said/VBD at/IN the/DT outset/NN ,/, for/IN this/DT attack/NN to/TO work/VB the/DT database/NN connection/NN must/MD be/VB encoded/VBN using/VBG a/DT vulnerable/JJ character/NN set/NN ./.
utf8mb4/COS is/VBZ not/RB vulnerable/JJ and/CC yet/RB can/MD support/VB every/DT Unicode/NNP character/NN :/: so/IN you/PRP could/MD elect/VB to/TO use/VB that/IN instead/RB --/: but/CC it/PRP has/VBZ only/RB been/VBN available/JJ since/IN MySQL/COS 5.5.3/CD ./.
An/DT alternative/NN is/VBZ utf8/COS ,/, which/WDT is/VBZ also/RB not/RB vulnerable/JJ and/CC can/MD support/VB the/DT whole/NN of/IN the/DT Unicode/NNP Basic/JJ Multilingual/JJ Plane/NN ./.
Alternatively/RB ,/, you/PRP can/MD enable/VB the/DT NO_BACKSLASH_ESCAPES/COS SQL/ACR mode/NN ,/, which/WDT -LRB-/-LRB- amongst/IN other/JJ things/NNS -RRB-/-RRB- alters/VBZ the/DT operation/NN of/IN mysql_real_escape_string/COS -LRB-/COS -RRB-/COS ./.
With/IN this/DT mode/NN enabled/VBD ,/, 0x27/COS will/MD be/VB replaced/VBN with/IN 0x2727/COS rather/RB than/IN 0x5c27/COS and/CC thus/RB the/DT escaping/VBG process/NN can/MD not/RB create/VB valid/JJ characters/NNS in/IN any/DT of/IN the/DT vulnerable/JJ encodings/NNS where/WRB they/PRP did/VBD not/RB exist/VB previously/RB -LRB-/-LRB- i.e./FW 0xbf27/COS is/VBZ still/RB 0xbf27/COS etc./FW -RRB-/-RRB- --/: so/IN the/DT server/NN will/MD still/RB reject/VB the/DT string/NN as/IN invalid/JJ ./.
However/RB ,/, see/VB @eggyal/ATS 's/POS answer/NN for/IN a/DT different/JJ vulnerability/NN that/WDT can/MD arise/VB from/IN using/VBG this/DT SQL/ACR mode/NN -LRB-/-LRB- albeit/RB not/RB with/IN PDO/ACR -RRB-/-RRB- ./.
Safe/NN Examples/NNS The/DT following/JJ examples/NNS are/VBP safe/JJ :/COB mysql_query/COB -LRB-/COB `/COB SET/COB NAMES/COB utf8/COB '/COB -RRB-/COB ;/COB $/COB var/COB =/COB mysql_real_escape_string/COB -LRB-/COB ''/COB \/COB xbf/COB \/COB x27/COB OR/COB 1/COB =/COB 1/COB //COB */COB ''/COB -RRB-/COB ;/: mysql_query/COB -LRB-/COB ``/COB SELECT/COB */COB FROM/COB test/COB WHERE/COB name/COB =/COB '/COB $/COB var/COB '/COB LIMIT/COB 1/COB ''/COB -RRB-/COB ;/COB Because/IN the/DT server/NN 's/POS expecting/VBG utf8/COS .../: mysql_set_charset/COB -LRB-/COB `/COB gbk/COB '/COB -RRB-/COB ;/COB $/COB var/COB =/COB mysql_real_escape_string/COB -LRB-/COB ''/COB \/COB xbf/COB \/COB x27/COB OR/COB 1/COB =/COB 1/COB //COB */COB ''/COB -RRB-/COB ;/COB mysql_query/COB -LRB-/COB ``/COB SELECT/COB */COB FROM/COB test/COB WHERE/COB name/COB =/COB '/COB $/COB var/COB '/COB LIMIT/COB 1/COB ''/COB -RRB-/COB ;/COB Because/IN we/PRP 've/VBP properly/RB set/VBN the/DT character/NN set/NN so/IN the/DT client/NN and/CC the/DT server/NN match/NN ./.
$/COB pdo/COB -/COB >/COB setAttribute/COB -LRB-/COB PDO/COB :/COB :/COB ATTR_EMULATE_PREPARES/COB ,/COB false/COB -RRB-/COB ;/COB $/COB pdo/COB -/COB >/COB query/COB -LRB-/COB `/COB SET/COB NAMES/COB gbk/COB '/COB -RRB-/COB ;/COB $/COB stmt/COB =/COB $/COB pdo/COB -/COB >/COB prepare/COB -LRB-/COB `/COB SELECT/COB */COB FROM/COB test/COB WHERE/COB name/COB =/COB ?/COB
LIMIT/COB 1/COB '/COB -RRB-/COB ;/COB $/COB stmt/COB -/COB >/COB execute/COB -LRB-/COB array/COB -LRB-/COB ''/COB \/COB xbf/COB \/COB x27/COB OR/COB 1/COB =/COB 1/COB //COB */COB ''/COB -RRB-/COB -RRB-/COB ;/COB Because/IN we/PRP 've/VBP turned/VBN off/RP emulated/VBN prepared/JJ statements/NNS ./.
$/COB pdo/COB =/COB new/COB PDO/COB -LRB-/COB `/COB mysql/COB :/COB host/COB =/COB localhost/COB ;/COB dbname/COB =/COB testdb/COB ;/COB charset/COB =/COB gbk/COB '/COB ,/COB $/COB user/COB ,/COB $/COB password/COB -RRB-/COB ;/COB $/COB stmt/COB =/COB $/COB pdo/COB -/COB >/COB prepare/COB -LRB-/COB `/COB SELECT/COB */COB FROM/COB test/COB WHERE/COB name/COB =/COB ?/COB
LIMIT/COB 1/COB '/COB -RRB-/COB ;/COB $/COB stmt/COB -/COB >/COB execute/COB -LRB-/COB array/COB -LRB-/COB ''/COB \/COB xbf/COB \/COB x27/COB OR/COB 1/COB =/COB 1/COB //COB */COB ''/COB -RRB-/COB -RRB-/COB ;/COB Because/IN we/PRP 've/VBP set/VBN the/DT character/NN set/VBN properly/RB ./.
$/COB mysqli/COB -/COB >/COB query/COB -LRB-/COB `/COB SET/COB NAMES/COB gbk/COB '/COB -RRB-/COB ;/COB $/COB stmt/COB =/COB $/COB mysqli/COB -/COB >/COB prepare/COB -LRB-/COB `/COB SELECT/COB */COB FROM/COB test/COB WHERE/COB name/COB =/COB ?/COB
LIMIT/COB 1/COB '/COB -RRB-/COB ;/COB $/COB param/COB =/COB ''/COB \/COB xbf/COB \/COB x27/COB OR/COB 1/COB =/COB 1/COB //COB */COB ''/COB ;/COB $/COB stmt/COB -/COB >/COB bind_param/COB -LRB-/COB 's/COB '/COB ,/COB $/COB param/COB -RRB-/COB ;/COB $/COB stmt/COB -/COB >/COB execute/COB -LRB-/COB -RRB-/COB ;/:COB Because/IN MySQLi/COS does/VBZ true/JJ prepared/JJ statements/NNS all/PDT the/DT time/NN ./.
Wrapping/VBG Up/RP If/IN you/PRP :/: Use/VB Modern/JJ Versions/NNS of/IN MySQL/COS -LRB-/-LRB- late/JJ 5.1/CD ,/, all/DT 5.5/CD ,/, 5.6/CD ,/, etc/FW -RRB-/-RRB- AND/CC PDO/ACR 's/POS DSN/ACR charset/NNC parameter/NN -LRB-/-LRB- in/IN PHP/ACR ?/.
5.3.6/CD -RRB-/-RRB- OR/CC Do/VBP n't/RB use/VB a/DT vulnerable/JJ character/NN set/VBN for/IN connection/NN encoding/NN -LRB-/-LRB- you/PRP only/RB use/VBP utf8/COS //: latin1/COS //: ascii/COS //: etc/FW -RRB-/-RRB- OR/CC Enable/JJ NO_BACKSLASH_ESCAPES/COS SQL/ACR mode/NN You/PRP 're/VBP 100/CD %/SYM safe/NN ./.
Otherwise/RB ,/, you/PRP 're/VBP vulnerable/JJ even/RB though/IN you/PRP 're/VBP using/VBG PDO/ACR Prepared/JJ Statements/NNS .../: Addendum/FW I/PRP 've/VBP been/VBN slowly/RB working/VBG on/IN a/DT patch/NN to/TO change/VB the/DT default/NN to/TO not/RB emulate/VB prepares/VBZ for/IN a/DT future/JJ version/NN of/IN PHP/ACR ./.
The/DT problem/NN that/IN I/PRP 'm/VBP running/VBG into/IN is/VBZ that/IN a/DT LOT/JJ of/IN tests/NNS break/VBP when/WRB I/PRP do/VBP that/DT ./.
One/CD problem/NN is/VBZ that/IN emulated/VBN prepares/VBZ will/MD only/RB throw/VB syntax/NN errors/NNS on/IN execute/VB ,/, but/CC true/JJ prepares/VBZ will/MD throw/VB errors/NNS on/IN prepare/VB ./.
So/IN that/DT can/MD cause/VB issues/NNS -LRB-/-LRB- and/CC is/VBZ part/NN of/IN the/DT reason/NN tests/NNS are/VBP borking/VBG -RRB-/-RRB- ./.
@nicogawenda/ATS :/: that/DT was/VBD a/DT different/JJ bug/NN ./.
Prior/RB to/TO 5.0.22/NN ,/, mysql_real_escape_string/COS would/MD n't/RB properly/RB handle/VB cases/NNS where/WRB the/DT connection/NN was/VBD properly/RB set/VBN to/TO BIG5/GBK/ACR ./.
So/RB actually/RB even/RB calling/VBG mysql_set_charset/COS -LRB-/COS -RRB-/COS on/IN mysql/COS </SYM 5.0.22/CD would/MD be/VB vulnerable/JJ to/TO this/DT bug/NN !/.
So/IN no/DT ,/, this/DT post/NN is/VBZ still/RB applicable/JJ to/TO 5.0.22/CD -LRB-/-LRB- because/IN mysql_real_escape_string/COS is/VBZ only/RB charset/NNC away/RB to/TO calls/NNS from/IN mysql_set_charset/COS -LRB-/COS -RRB-/COS ,/, which/WDT is/VBZ what/WP this/DT post/NN is/VBZ talking/VBG about/IN bypassing/VBG -RRB-/-RRB- .../:
